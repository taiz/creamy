package views;

import creamy.activity.AvailableActivity;
import creamy.activity.requestor.CallBack;
import creamy.mvc.Status;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.Map;
import javafx.animation.FadeTransitionBuilder;
import javafx.animation.SequentialTransition;
import javafx.animation.SequentialTransitionBuilder;
import javafx.event.ActionEvent;
import javafx.event.EventHandler;
import javafx.fxml.FXML;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.TextField;
import javafx.scene.layout.VBox;
import javafx.util.Duration;

/**
 *
 * @author miyabetaiji
 */
public class TestEditableItem extends AvailableActivity {
    @FXML private Integer computerId;
    @FXML private TextField computerName;
    @FXML private TextField introduced;
    @FXML private TextField discontinued;
    @FXML private Label companyName;
    
    private TestEditableList parent;
    @Override
    public void initialize() {
        parent = (TestEditableList)getParent();
        messageAnimation.setNode(message);
    }
    
    @FXML private Button showBtn;
    
    @FXML private void showCompany(ActionEvent event) {
        String path = "/TestEditableController/testCompanyName/" + computerId;
        requestData(path)
                .onSuccess(new CallBack<Object>() {
                    @Override
                    public void call(Object data, Status status) {
                        companyName.setText(data.toString());
                    }
                })
                .execute();
    }
    
    @FXML private Button updateBtn;
    
    // 課題：Formから一度にバインドしたい
    @FXML private void updateComputer(ActionEvent event) {
        Map<String,Object> params = new HashMap<String,Object>() {{
           put("id", computerId);
           put("name", computerName.getText());
           put("introduced", introduced.getText());
           put("discontinued", discontinued.getText());
        }};
        requestData("/TestEditableController/updateComputer")
                .params(params)
                .onSuccess(new CallBack<Object>() {
                    @Override
                    public void call(Object data, Status status) {
                        message.setText("updated");
                        messageAnimation.play();
                    }      
                })
                .execute();
    }
    
    @FXML private Button deleteBtn;
    
    @FXML private void deleteComputer(ActionEvent event) {
        String path = "/TestEditableController/deleteComputer/" + computerId;
        requestData(path)
                .onSuccess(new CallBack<Object>() {
                    @Override
                    public void call(Object data, Status status) {
                        messageAnimation.setOnFinished(new EventHandler<ActionEvent>() {
                            @Override
                            public void handle(ActionEvent t) {
                                //((VBox)scene.getParent()).getChildren().remove(scene);
                                parent.removed(TestEditableItem.this);
                            }
                        });
                        message.setText("deleted");
                        messageAnimation.play();
                    }
                })
                .execute();
    }
    
    @FXML private Label message;
    
    private SequentialTransition messageAnimation = SequentialTransitionBuilder.create()
            //.node(message)
            .children(
                FadeTransitionBuilder.create()
                    .fromValue(0).toValue(1.0)
                    .duration(Duration.seconds(1.0))
                    .build(),
                FadeTransitionBuilder.create()
                    .fromValue(1.0).toValue(0.0)
                    .duration(Duration.seconds(1.0))
                    .build()
            ).build();
}
